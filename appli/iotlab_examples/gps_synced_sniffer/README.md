ZEP SNIFFER with GPS SYNCED timestamps
======================================


Overview
--------

4 components:
- radio sniffer outputing zep on serial line
- gps timestamping lib
- `control_node_i2c` lib to get current time
- serial2loopback.py script wrapping zep as udp

Running a demo
--------------

0 . grab two A8 nodes in rocquencourt - all have GPS:
   - 1 sniffer node (M3 on A8 and A8 with GPS required)
   - 1 emitter node (M3 only required)

nodes need to be in range radio-wize

1. build M3 firmware files and copy to nodes
2. copy serial2loopback.py to sniffer node
3. flash sniffer and emitter M3's
4. run ./serial2loopback.py on sniffer node
5. run tcpdump -vvv -i lo on sniffer node
6. send packet from emitter node
7. check sniffer node's tcpdump output to see zep packet
8. use e.g. wireshark to inspect packets contents


Full trace of basic demo
------------------------
```
ssh rocquencourt.iot-lab.info
experiment-cli submit -d 15 -l rocquencourt,a8,2+3

(use auth-cli if this is a first time init)

git clone https://github.com/iot-lab/openlab.git
cd openlab/ && mkdir build.a8
cd build.a8/ && cmake .. -DPLATFORM=iotlab-a8-m3
make tutorial_a8_m3 gps_synced_sniffer

scp bin/gps_synced_sniffer.elf root@node-a8-2:
scp bin/tutorial_a8_m3.elf root@node-a8-3:
scp ../appli/iotlab_examples/gps_synced_sniffer/serial2loopback.py root@node-a8-2:

setup sniffer node:

ssh root@node-a8-2
flash_a8_m3 gps_synced_sniffer.elf
./serial2loopback.py &
tcpdump -vvv -i lo

in another terminal, send a packet from emitter:

ssh rocquencourt.iot-lab.info
ssh root@node-a8-3
flash_a8_m3 tutorial_a8_m3.elf
miniterm.py --echo /dev/ttyA8_M3 500000
<type return to stop help screen>
<type 's' to send radio packet>
<type crtl-] to exit>
```

check the raw tcpdump output; should look like the following:

```
tcpdump: listening on lo, link-type EN10MB (Ethernet), capture size 65535 bytes
.+10:30:17.843017 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 82)
    localhost.localdomain.55249 > localhost.localdomain.17754: [bad udp cksum 0xfe51 -> 0xb98f!] UDP, length 54

```

Note 1: the ".+" in the tcpdump trace above are generated by serial2loopback.py,
the "bad udp cksum" are "expected" but not clearly explained as of now.

Note 2: serial2loopback.py declares a (silent) UDP listener on port 17754 so as to
avoid local IP stack ICMP errors messages.

Note 3: to transfer files to the A8 nodes, you may as well use directory "~/A8",
available on the ssh frontends.


Inspect sniffer packets using wireshark from your PC:
-----------------------------------------------------

- make sure you have wireshark installed on your PC
- make sure you have ~/.ssh/config configured as follows:

```
Host node-a8-*.rocquencourt.iot-lab.info
  User root
  ProxyCommand ssh rocquencourt.iot-lab.info -W %h:%p
  StrictHostKeyChecking no
```

then, in another terminal:

```
ssh node-a8-2.rocquencourt.iot-lab.info tcpdump -vvv -i lo -w - | wireshark -i -
```

click "start" in the wireshark interface.


back to the "emitter" terminal:

send enough packets for wireshark to kick in (approx 40 small packets)

wireshark shows timestamp, sequence number, messages data for received packets
in ZEP format (Zigbee Encapsulation Protocol)
